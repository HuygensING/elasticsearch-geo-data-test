<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<style>
			#map {
		        	height: 100%;
			        width: 100%
			}
			html, body {
        	       		height: 100%;
	        		margin: 0;
        			padding: 0;
      			}
		</style>
	</head>
	<body>
		<div id="map">
		</div>
		<script src="js/latlon-geohash.js"></script>
		<script>
			var currentMarkers = [];
			function addMarker(map, geohash, doc_count) {
				var coordinates = Geohash.decode(geohash);
				var marker = new google.maps.Marker({
					position: { lat: coordinates.lat, lng: coordinates.lon },
					map: map,
					title: "" + doc_count
				});
				var contentString = '<div id="content">'+
			       		'<div id="siteNotice">'+
      					'</div>'+
				        '<h1 id="firstHeading" class="firstHeading">' + doc_count + '</h1>'+
				        '<div id="bodyContent">'+
      					'</div>'+
      					'</div>';

				var infoWindow = new google.maps.InfoWindow({
					content: contentString
				});
				marker.addListener('click', function() {
					infoWindow.open(map, marker);
				});
				currentMarkers.push(marker);

			}
			
			function addOverlay(map) {
				var imageBounds = {
			        	north: 52.384,
          				south: 52.35,
          				east: 4.933,
          				west: 4.860
			        };
				var overlay = new google.maps.GroundOverlay("large-detailed-old-map-of-amsterdam-city-(1385-1875)[rotate].png", imageBounds);
				overlay.setMap(map);
			}
			
			function fillMap(map, markers) {
				// remove old markers from the map		
				while (currentMarkers.length > 0) {
					currentMarkers.pop().setMap(null);
				}
				markers.forEach(function(element) {
					addMarker(map, element.key, element.doc_count);
				});
			}
			
			function executeQuery(map, precision) {
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() {
					if (xhr.readyState === 4) {
						var responseData = JSON.parse(xhr.response);									
						fillMap(map, responseData.aggregations.test.buckets);
					}				
				}
			
				xhr.open("POST", "http://localhost:9200/geo_data/_search", true);
				xhr.setRequestHeader("Content-type", "application/json");
				xhr.send(JSON.stringify({ "size": 0,
					"query" : {
						"match_all": {}
					},
					"aggs": {
						"test": {
							"geohash_grid": {
								"field": "geometry.coordinates",
								"precision": precision 
							}
						}
					}
				}));
				
			}
			var defaultZoom = 13;
			var defaultPrecision = 5;
			function calculatePrecision(currentZoom) {
				return (currentZoom / defaultZoom) * defaultPrecision;
			}
			
			function initMap() {
				var amsterdam = { lat: 52.35, lng: 4.80 };
				var map = new google.maps.Map(document.getElementById('map'), {
					center: amsterdam,
					zoom: 13
				});
				map.addListener("bounds_changed", function() {
					console.log(map.getBounds());
				});
				addOverlay(map);				
				map.addListener("zoom_changed", function() {
					console.log("zoom", map.getZoom());
					console.log("precision", calculatePrecision(map.getZoom()));
					executeQuery(map, calculatePrecision(map.getZoom()));	
				});
				executeQuery(map, 5);
			}					
		</script>
		<script async defer
		src="https://maps.googleapis.com/maps/api/js?callback=initMap">
		</script>
	</body>
</html>
